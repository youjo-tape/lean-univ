import kassel.Tangle
import category_theory.monoidal.braided
import kassel.lemma.right_pivotal_category

open category_theory category_theory.monoidal_category

namespace kassel

universes v u
variables
  {C: Type u}
  [category.{v} C]
  [monoidal_category.{v} C]
  [right_rigid_category.{v} C]
  [right_pivotal_category.{v} C]
  [braided_category.{v} C]

def flip (V W: C) := (╬▓_ V W).hom
notation `¤ё_` := flip

def trace {V: C} (f: V РЪХ V) := ╬и_РЂ║ _ РЅФ (f РіЌ ­ЮЪЎ VрўЂ) РЅФ ╬х_РЂ╗ _

def trace_2 {V: C} (f: V РіЌ V РЪХ V РіЌ V)
  :=                  (¤Ђ_ _).inv
  РЅФ (­ЮЪЎ V РіЌ ╬и_РЂ║ _) РЅФ (╬▒_ _ _ _).inv
  РЅФ (f РіЌ ­ЮЪЎ VрўЂ)    РЅФ (╬▒_ _ _ _).hom
  РЅФ (­ЮЪЎ V РіЌ ╬х_РЂ╗ _) РЅФ (¤Ђ_ _).hom

variable (C)

structure enhanced_R_matrix (V: C) :=
  (c: V РіЌ V РЅЁ V РіЌ V)
  (╬╝: V РЅЁ V)
  (relation_1:
       (­ЮЪЎ V РіЌ c.hom) РЅФ (╬▒_ _ _ _).inv
    РЅФ (c.hom РіЌ ­ЮЪЎ V) РЅФ (╬▒_ _ _ _).hom
    РЅФ (­ЮЪЎ V РіЌ c.hom) РЅФ (╬▒_ _ _ _).inv
  =                    (╬▒_ _ _ _).inv
    РЅФ (c.hom РіЌ ­ЮЪЎ V) РЅФ (╬▒_ _ _ _).hom
    РЅФ (­ЮЪЎ V РіЌ c.hom) РЅФ (╬▒_ _ _ _).inv
    РЅФ (c.hom РіЌ ­ЮЪЎ V)
  )
  (relation_2: c.hom РЅФ (╬╝.hom РіЌ ╬╝.hom) = (╬╝.hom РіЌ ╬╝.hom) РЅФ c.hom)
  (relation_3_1: trace_2 (c.hom РЅФ (­ЮЪЎ V РіЌ ╬╝.hom)) = ­ЮЪЎ V)
  (relation_3_2: trace_2 (c.inv РЅФ (­ЮЪЎ V РіЌ ╬╝.hom)) = ­ЮЪЎ V)
  (relation_4_1: (╬╗_ (V РіЌ VрўЂ)).inv РЅФ (╬и_РЂ╗ V РЅФ (­ЮЪЎ VрўЂ РіЌ ╬╝.inv) РіЌ ­ЮЪЎ V РіЌ ­ЮЪЎ VрўЂ) РЅФ (╬▒_ VрўЂ V (V РіЌ VрўЂ)).hom РЅФ (­ЮЪЎ VрўЂ РіЌ (╬▒_ V V VрўЂ).inv) РЅФ (­ЮЪЎ VрўЂ РіЌ c.inv РіЌ ­ЮЪЎ VрўЂ) РЅФ (­ЮЪЎ VрўЂ РіЌ (╬▒_ V V VрўЂ).hom) РЅФ (╬▒_ VрўЂ V (V РіЌ VрўЂ)).inv РЅФ ((­ЮЪЎ VрўЂ РіЌ ­ЮЪЎ V) РіЌ (╬╝.hom РіЌ ­ЮЪЎ VрўЂ) РЅФ ╬х_РЂ╗ V) РЅФ ((­ЮЪЎ VрўЂ РіЌ ­ЮЪЎ V) РіЌ ╬и_РЂ║ V) РЅФ (╬▒_ VрўЂ V (V РіЌ VрўЂ)).hom РЅФ (­ЮЪЎ VрўЂ РіЌ (╬▒_ V V VрўЂ).inv) РЅФ (­ЮЪЎ VрўЂ РіЌ c.hom РіЌ ­ЮЪЎ VрўЂ) РЅФ (­ЮЪЎ VрўЂ РіЌ (╬▒_ V V VрўЂ).hom) РЅФ (╬▒_ VрўЂ V (V РіЌ VрўЂ)).inv РЅФ (╬х_РЂ║ V РіЌ ­ЮЪЎ V РіЌ ­ЮЪЎ VрўЂ) РЅФ (╬╗_ (V РіЌ VрўЂ)).hom = ­ЮЪЎ V РіЌ ­ЮЪЎ VрўЂ)
  (relation_4_2: (╬╗_ (V РіЌ VрўЂ)).inv РЅФ (╬и_РЂ╗ V РЅФ (­ЮЪЎ VрўЂ РіЌ ╬╝.inv) РіЌ ­ЮЪЎ V РіЌ ­ЮЪЎ VрўЂ) РЅФ (╬▒_ VрўЂ V (V РіЌ VрўЂ)).hom РЅФ (­ЮЪЎ VрўЂ РіЌ (╬▒_ V V VрўЂ).inv) РЅФ (­ЮЪЎ VрўЂ РіЌ c.hom РіЌ ­ЮЪЎ VрўЂ) РЅФ (­ЮЪЎ VрўЂ РіЌ (╬▒_ V V VрўЂ).hom) РЅФ (╬▒_ VрўЂ V (V РіЌ VрўЂ)).inv РЅФ ((­ЮЪЎ VрўЂ РіЌ ­ЮЪЎ V) РіЌ (╬╝.hom РіЌ ­ЮЪЎ VрўЂ) РЅФ ╬х_РЂ╗ V) РЅФ ((­ЮЪЎ VрўЂ РіЌ ­ЮЪЎ V) РіЌ ╬и_РЂ║ V) РЅФ (╬▒_ VрўЂ V (V РіЌ VрўЂ)).hom РЅФ (­ЮЪЎ VрўЂ РіЌ (╬▒_ V V VрўЂ).inv) РЅФ (­ЮЪЎ VрўЂ РіЌ c.inv РіЌ ­ЮЪЎ VрўЂ) РЅФ (­ЮЪЎ VрўЂ РіЌ (╬▒_ V V VрўЂ).hom) РЅФ (╬▒_ VрўЂ V (V РіЌ VрўЂ)).inv РЅФ (╬х_РЂ║ V РіЌ ­ЮЪЎ V РіЌ ­ЮЪЎ VрўЂ) РЅФ (╬╗_ (V РіЌ VрўЂ)).hom = ­ЮЪЎ V РіЌ ­ЮЪЎ VрўЂ)
  (relation_4_3: (¤Ђ_ (VрўЂ РіЌ V)).inv РЅФ ((­ЮЪЎ VрўЂ РіЌ ­ЮЪЎ V) РіЌ ╬и_РЂ║ V) РЅФ (╬▒_ VрўЂ V (V РіЌ VрўЂ)).hom РЅФ (­ЮЪЎ VрўЂ РіЌ (╬▒_ V V VрўЂ).inv) РЅФ (­ЮЪЎ VрўЂ РіЌ c.hom РіЌ ­ЮЪЎ VрўЂ) РЅФ (­ЮЪЎ VрўЂ РіЌ (╬▒_ V V VрўЂ).hom) РЅФ (╬▒_ VрўЂ V (V РіЌ VрўЂ)).inv РЅФ (╬х_РЂ║ V РіЌ ­ЮЪЎ V РіЌ ­ЮЪЎ VрўЂ) РЅФ (╬и_РЂ╗ V РЅФ (­ЮЪЎ VрўЂ РіЌ ╬╝.inv) РіЌ ­ЮЪЎ V РіЌ ­ЮЪЎ VрўЂ) РЅФ (╬▒_ VрўЂ V (V РіЌ VрўЂ)).hom РЅФ (­ЮЪЎ VрўЂ РіЌ (╬▒_ V V VрўЂ).inv) РЅФ (­ЮЪЎ VрўЂ РіЌ c.inv РіЌ ­ЮЪЎ VрўЂ) РЅФ (­ЮЪЎ VрўЂ РіЌ (╬▒_ V V VрўЂ).hom) РЅФ (╬▒_ VрўЂ V (V РіЌ VрўЂ)).inv РЅФ ((­ЮЪЎ VрўЂ РіЌ ­ЮЪЎ V) РіЌ (╬╝.hom РіЌ ­ЮЪЎ VрўЂ) РЅФ ╬х_РЂ╗ V) РЅФ (¤Ђ_ (VрўЂ РіЌ V)).hom = ­ЮЪЎ VрўЂ РіЌ ­ЮЪЎ V)
  (relation_4_4: (¤Ђ_ (VрўЂ РіЌ V)).inv РЅФ ((­ЮЪЎ VрўЂ РіЌ ­ЮЪЎ V) РіЌ ╬и_РЂ║ V) РЅФ (╬▒_ VрўЂ V (V РіЌ VрўЂ)).hom РЅФ (­ЮЪЎ VрўЂ РіЌ (╬▒_ V V VрўЂ).inv) РЅФ (­ЮЪЎ VрўЂ РіЌ c.inv РіЌ ­ЮЪЎ VрўЂ) РЅФ (­ЮЪЎ VрўЂ РіЌ (╬▒_ V V VрўЂ).hom) РЅФ (╬▒_ VрўЂ V (V РіЌ VрўЂ)).inv РЅФ (╬х_РЂ║ V РіЌ ­ЮЪЎ V РіЌ ­ЮЪЎ VрўЂ) РЅФ (╬и_РЂ╗ V РЅФ (­ЮЪЎ VрўЂ РіЌ ╬╝.inv) РіЌ ­ЮЪЎ V РіЌ ­ЮЪЎ VрўЂ) РЅФ (╬▒_ VрўЂ V (V РіЌ VрўЂ)).hom РЅФ (­ЮЪЎ VрўЂ РіЌ (╬▒_ V V VрўЂ).inv) РЅФ (­ЮЪЎ VрўЂ РіЌ c.hom РіЌ ­ЮЪЎ VрўЂ) РЅФ (­ЮЪЎ VрўЂ РіЌ (╬▒_ V V VрўЂ).hom) РЅФ (╬▒_ VрўЂ V (V РіЌ VрўЂ)).inv РЅФ ((­ЮЪЎ VрўЂ РіЌ ­ЮЪЎ V) РіЌ (╬╝.hom РіЌ ­ЮЪЎ VрўЂ) РЅФ ╬х_РЂ╗ V) РЅФ (¤Ђ_ (VрўЂ РіЌ V)).hom = ­ЮЪЎ VрўЂ РіЌ ­ЮЪЎ V)

variable {C}

namespace enhanced_R_matrix

variables (V: C) (R: enhanced_R_matrix C V)

@[simp] def functor_obj: Tangle Рєњ C
  | Tangle.id := ­ЮЪЎ_ C
  | РєЊ := V
  | РєЉ := VрўЂ
  | (a РіЌрхЌ b) := functor_obj a РіЌ functor_obj b

def functor_map: ╬а {X Y}, (X РЪХрхљ Y) Рєњ (functor_obj V X РЪХ functor_obj V Y)
  | _ _ (­ЮЪЎрхљ a) := ­ЮЪЎ (functor_obj V a)
  | _ _ (f РЅФрхљ g) := functor_map f РЅФ functor_map g
  | _ _ (f РіЌрхљ g) := functor_map f РіЌ functor_map g
  | _ _ (╬▒ _ _ _) := (╬▒_ _ _ _).hom
  | _ _ (╬▒РЂ╗┬╣ _ _ _) := (╬▒_ _ _ _).inv
  | _ _ (РёЊ _) := (╬╗_ _).hom
  | _ _ (РёЊРЂ╗┬╣ _) := (╬╗_ _).inv
  | _ _ (¤Ђ _) := (¤Ђ_ _).hom
  | _ _ (¤ЂРЂ╗┬╣ _) := (¤Ђ_ _).inv
  | _ _ ╬иРЂ║ := ╬и_РЂ║ V
  | _ _ ╬иРЂ╗ := ╬и_РЂ╗ _ РЅФ (­ЮЪЎ VрўЂ РіЌ R.╬╝.inv)
  | _ _ ╬хРЂ║ := ╬х_РЂ║ _
  | _ _ ╬хРЂ╗ := (R.╬╝.hom РіЌ ­ЮЪЎ VрўЂ) РЅФ ╬х_РЂ╗ V
  | _ _ ╬▓ := R.c.hom
  | _ _ ╬▓РЂ╗┬╣ := R.c.inv


namespace aux

lemma relation_2_c_inv:
  R.c.inv РЅФ (R.╬╝.hom РіЌ R.╬╝.hom) = (R.╬╝.hom РіЌ R.╬╝.hom) РЅФ R.c.inv :=
by rw [iso.eq_comp_inv, category.assoc, iso.inv_comp_eq, R.relation_2]

lemma functor_map_well_defined_1_1:
  functor_map V R (¤ЂРЂ╗┬╣ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬иРЂ╗ РЅФрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ╬хРЂ╗ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ РёЊ _) =
  functor_map V R (­ЮЪЎрхљ _) :=
begin
  dsimp [functor_map],
  simp_rw [id_tensor_comp, comp_tensor_id, category.assoc],
  
  rw Рєљassociator_inv_naturality_assoc,
  iterate 2 { rw [Рєљtensor_comp_assoc _ _ R.╬╝.hom _, id_comp_comp_id R.╬╝.hom, tensor_comp_assoc], },
  rw [tensor_id, tensor_id, category.id_comp],
  rw [Рєљtensor_id_comp_id_tensor_assoc _ R.╬╝.hom, Рєљright_unitor_inv_naturality_assoc],

  rw associator_inv_naturality_assoc,
  rw [Рєљtensor_comp_assoc, Рєљid_comp_comp_id, tensor_comp_assoc],
  rw [tensor_id, tensor_id, category.id_comp],
  rw [Рєљtensor_id_comp_id_tensor_assoc R.╬╝.inv _, left_unitor_naturality],

  slice_lhs 3 5 { rw coevaluation_evaluation_rev, },
  simp_rw [category.assoc, iso.inv_hom_id_assoc],
  rw iso.hom_inv_id,
end

lemma functor_map_well_defined_1_2:
  functor_map V R (РёЊРЂ╗┬╣ _ РЅФрхљ ╬иРЂ║ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ ╬▒ _ _ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬хРЂ║ РЅФрхљ ¤Ђ _) = functor_map V R (­ЮЪЎрхљ _) :=
begin
  dsimp [functor_map],
  rw [evaluation_coevaluation_assoc, iso.inv_hom_id_assoc, iso.inv_hom_id],
end

lemma functor_map_well_defined_2_1:
  functor_map V R (¤ЂРЂ╗┬╣ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬иРЂ║ РЅФрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ╬хРЂ║ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ РёЊ _) = functor_map V R (­ЮЪЎрхљ _) :=
begin
  dsimp [functor_map],
  rw [coevaluation_evaluation_assoc, iso.inv_hom_id_assoc, iso.inv_hom_id],
end

lemma functor_map_well_defined_2_2:
  functor_map V R (РёЊРЂ╗┬╣ _ РЅФрхљ ╬иРЂ╗ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ ╬▒ _ _ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬хРЂ╗ РЅФрхљ ¤Ђ _) = functor_map V R (­ЮЪЎрхљ _) :=
begin
  dsimp [functor_map],
  simp_rw [id_tensor_comp, comp_tensor_id, category.assoc],
  rw associator_naturality_assoc,
  slice_lhs 4 5 { rw [Рєљtensor_comp, Рєљtensor_comp, category.comp_id, iso.inv_hom_id, tensor_id, tensor_id], },
  rw category.id_comp,
  rw [evaluation_coevaluation_rev_assoc, iso.inv_hom_id_assoc, iso.inv_hom_id],
end

abbreviation functor_map_well_defined_3_lhs (b: РєЊ РіЌрхЌ РєЊ РЪХрхљ РєЊ РіЌрхЌ РєЊ) :=
  functor_map V R (                             РёЊРЂ╗┬╣ _
    РЅФрхљ ╬иРЂ╗                   РіЌрхљ ­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ РЅФрхљ (­ЮЪЎрхљ РєЉ РіЌрхљ РёЊРЂ╗┬╣ _) РіЌрхљ ­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ
    РЅФрхљ (­ЮЪЎрхљ РєЉ РіЌрхљ ╬иРЂ╗ РіЌрхљ ­ЮЪЎрхљ РєЊ) РіЌрхљ ­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ РЅФрхљ (­ЮЪЎрхљ РєЉ РіЌрхљ ╬▒ _ _ _) РіЌрхљ ­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ РЅФрхљ ╬▒РЂ╗┬╣ _ _ _ РіЌрхљ ­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ РЅФрхљ ╬▒ _ _ _
    РЅФрхљ (­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ) РіЌрхљ b  РіЌрхљ ­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ РЅФрхљ (­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ) РіЌрхљ ╬▒ _ _ _ РЅФрхљ (­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ) РіЌрхљ ­ЮЪЎрхљ РєЊ РіЌрхљ ╬▒РЂ╗┬╣ _ _ _
    РЅФрхљ (­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ) РіЌрхљ ­ЮЪЎрхљ РєЊ РіЌрхљ ╬хРЂ╗ РіЌрхљ ­ЮЪЎрхљ РєЉ РЅФрхљ (­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ) РіЌрхљ ­ЮЪЎрхљ РєЊ РіЌрхљ РёЊ _
    РЅФрхљ (­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ) РіЌрхљ ╬хРЂ╗                 РЅФрхљ ¤Ђ _
  )

abbreviation functor_map_well_defined_3_rhs (b: РєЊ РіЌрхЌ РєЊ РЪХрхљ РєЊ РіЌрхЌ РєЊ) :=
  functor_map V R (                             ¤ЂРЂ╗┬╣ _
    РЅФрхљ (­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ) РіЌрхљ ╬иРЂ║                 РЅФрхљ (­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ) РіЌрхљ ­ЮЪЎрхљ РєЊ РіЌрхљ РёЊРЂ╗┬╣ РєЉ
    РЅФрхљ (­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ) РіЌрхљ ­ЮЪЎрхљ РєЊ РіЌрхљ ╬иРЂ║ РіЌрхљ ­ЮЪЎрхљ РєЉ РЅФрхљ (­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ) РіЌрхљ ­ЮЪЎрхљ РєЊ РіЌрхљ ╬▒ _ _ _ РЅФрхљ (­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ) РіЌрхљ ╬▒РЂ╗┬╣ _ _ _
    РЅФрхљ (­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ) РіЌрхљ b  РіЌрхљ ­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ РЅФрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ╬▒ _ _ _ РіЌрхљ ­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ РЅФрхљ (­ЮЪЎрхљ РєЉ РіЌрхљ ╬▒РЂ╗┬╣ _ _ _) РіЌрхљ ­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ
    РЅФрхљ (­ЮЪЎрхљ РєЉ РіЌрхљ ╬хРЂ║ РіЌрхљ ­ЮЪЎрхљ РєЊ) РіЌрхљ ­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ РЅФрхљ (­ЮЪЎрхљ РєЉ РіЌрхљ РёЊ _) РіЌрхљ ­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ
    РЅФрхљ ╬хРЂ║                   РіЌрхљ ­ЮЪЎрхљ РєЉ РіЌрхљ ­ЮЪЎрхљ РєЉ РЅФрхљ РёЊ _
  )

abbreviation functor_map_well_defined_3_mid (b: РєЊ РіЌрхЌ РєЊ РЪХрхљ РєЊ РіЌрхЌ РєЊ) :=
  (╬┤_ V V).inv РЅФ (functor_map V R b)рўЂ РЅФ (╬┤_ V V).hom

lemma functor_map_well_defined_3_left (b: РєЊ РіЌрхЌ РєЊ РЪХрхљ РєЊ РіЌрхЌ РєЊ) (h: functor_map V R b РЅФ (R.╬╝.hom РіЌ R.╬╝.hom) = (R.╬╝.hom РіЌ R.╬╝.hom) РЅФ functor_map V R b):
  functor_map_well_defined_3_lhs V R b =
  functor_map_well_defined_3_mid V R b :=
begin
  dunfold functor_map_well_defined_3_lhs,
  dunfold functor_map_well_defined_3_mid,
  dsimp [functor_map],
  simp only [tensor_id, id_tensor_comp, comp_tensor_id, category.assoc],
  
  iterate 6 { rw [Рєљtensor_comp_assoc _ (­ЮЪЎ (VрўЂ РіЌ VрўЂ)) _ (­ЮЪЎ (VрўЂ РіЌ VрўЂ)), category.comp_id], repeat { rw category.assoc, }, },
  rw [Рєљtensor_comp_assoc _ R.╬╝.inv _ _, left_unitor_inv_naturality, tensor_comp_assoc],
  iterate 2 { rw [Рєљtensor_comp_assoc _ (_ РіЌ R.╬╝.inv) _ _, Рєљtensor_comp _ R.╬╝.inv _ _, Рєљid_comp_comp_id R.╬╝.inv, tensor_comp, tensor_comp_assoc], },
  rw [Рєљtensor_comp_assoc _ (_ РіЌ R.╬╝.inv) _ _, associator_naturality, tensor_comp_assoc],
  rw associator_inv_naturality,
  rw [tensor_id, id_tensor_comp_tensor_id_assoc, Рєљcategory.id_comp ((_ РіЌ ­ЮЪЎ VрўЂ) РіЌ (_ РіЌ R.╬╝.inv)), Рєљtensor_id],
  nth_rewrite 0 Рєљ(╬┤_ _ _).inv_hom_id,
  rw [comp_tensor_id_assoc (╬┤_ _ _).inv _ _, Рєљcoevaluation_rev_tensor_assoc],
  rw [tensor_id, tensor_id_comp_id_tensor, comp_tensor_id_assoc, associator_naturality_assoc],

  iterate 6 { nth_rewrite 1 Рєљtensor_comp_assoc (­ЮЪЎ (VрўЂ РіЌ VрўЂ)) _ (­ЮЪЎ (VрўЂ РіЌ VрўЂ)) _, rw category.comp_id, repeat { rw category.assoc, }, },
  rw [Рєљtensor_comp_assoc _ _ _ ((R.╬╝.hom РіЌ ­ЮЪЎ _) РіЌ ­ЮЪЎ VрўЂ), Рєљassociator_inv_naturality, tensor_comp_assoc],
  iterate 4 { rw [Рєљtensor_comp_assoc _ _ R.╬╝.hom _, id_comp_comp_id R.╬╝.hom, tensor_comp_assoc], },
  rw [Рєљassociator_naturality_assoc R.╬╝.hom _ _, tensor_id, Рєљtensor_id_comp_id_tensor_assoc _ (R.╬╝.hom РіЌ _)],
  nth_rewrite 6 Рєљ(╬┤_ _ _).inv_hom_id,
  rw [id_tensor_comp_assoc (╬┤_ _ _).inv _, tensor_id_comp_id_tensor_assoc],
  rw [tensor_id, category.id_comp, Рєљevaluation_rev_tensor],
  rw id_tensor_comp_assoc,

  iterate 3 { rw [Рєљtensor_comp_assoc (╬┤_ _ _).hom _ _ _, Рєљid_comp_comp_id, tensor_comp_assoc], },
  rw [Рєљid_tensor_comp_tensor_id_assoc _ (╬┤_ _ _).hom, right_unitor_naturality],
  simp_rw Рєљcategory.assoc, rw iso.cancel_iso_hom_right, simp_rw category.assoc,
  
  simp_rw Рєљassociator_naturality_assoc,
  iterate 3 { rw [Рєљtensor_comp_assoc _ _ _ (╬┤_ _ _).inv, id_comp_comp_id, tensor_comp_assoc], },
  rw [Рєљid_tensor_comp_tensor_id_assoc (╬┤_ _ _).inv _, Рєљleft_unitor_inv_naturality_assoc],
  rw iso.cancel_iso_inv_left,
  
  slice_lhs 3 5 { simp only [Рєљtensor_comp, category.id_comp], },
  simp_rw category.assoc, rw right_adjoint_mate_rev,
  rw [h, Рєљtensor_iso_hom, Рєљtensor_iso_inv, iso.inv_hom_id_assoc],
end

lemma functor_map_well_defined_3_right (b: РєЊ РіЌрхЌ РєЊ РЪХрхљ РєЊ РіЌрхЌ РєЊ):
  functor_map_well_defined_3_rhs V R b =
  functor_map_well_defined_3_mid V R b :=
begin
  dunfold functor_map_well_defined_3_rhs,
  dunfold functor_map_well_defined_3_mid,
  dsimp [functor_map],
  simp only [tensor_id, id_tensor_comp, comp_tensor_id, category.assoc],
  
  iterate 4 { rw Рєљtensor_comp_assoc (­ЮЪЎ (VрўЂ РіЌ VрўЂ)) _ (­ЮЪЎ (VрўЂ РіЌ VрўЂ)) _, rw category.comp_id, }, repeat { rw category.assoc, },
  rw [Рєљcategory.comp_id (╬▒_ V V (VрўЂ РіЌ VрўЂ)).inv, Рєљtensor_id (V РіЌ V) (VрўЂ РіЌ VрўЂ)],
  nth_rewrite 1 Рєљ(╬┤_ _ _).inv_hom_id, rw id_tensor_comp (╬┤_ V V).inv _,
  rw [Рєљcoevaluation_hom_tensor_assoc, id_tensor_comp_assoc],

  iterate 4 { rw Рєљcomp_tensor_id_assoc, }, repeat { rw category.assoc, },
  rw [Рєљcategory.id_comp (╬▒_ VрўЂ VрўЂ (V РіЌ V)).hom, Рєљtensor_id (VрўЂ РіЌ VрўЂ) (V РіЌ V)],
  nth_rewrite 4 Рєљ(╬┤_ _ _).inv_hom_id, rw comp_tensor_id_assoc (╬┤_ V V).inv _, repeat { rw category.assoc, },
  rw [Рєљevaluation_hom_tensor, comp_tensor_id_assoc],

  rw Рєљassociator_inv_naturality_assoc,
  iterate 3 { rw [Рєљtensor_comp_assoc  _ _ (╬┤_ _ _).inv _, id_comp_comp_id, tensor_comp_assoc], },
  rw [Рєљtensor_id_comp_id_tensor_assoc _ (╬┤_ _ _).inv, Рєљright_unitor_inv_naturality_assoc],
  rw iso.cancel_iso_inv_left,
  
  slice_lhs 3 5 { simp only [Рєљtensor_comp, category.comp_id], rw @category.id_comp _ _ (V РіЌ V) (V РіЌ V) (functor_map V R b), }, simp_rw category.assoc,
  rw associator_inv_naturality_assoc,
  rw Рєљtensor_id_comp_id_tensor_assoc (╬┤_ V V).hom _,
  rw [Рєљtensor_comp_assoc _ (╬┤_ _ _).hom _ _, Рєљid_comp_comp_id, tensor_comp_assoc],
  rw [Рєљtensor_id_comp_id_tensor_assoc (╬┤_ V V).hom _, left_unitor_naturality],
  simp_rw Рєљcategory.assoc, rw iso.cancel_iso_hom_right, simp_rw category.assoc,

  simp_rw [tensor_id, category.id_comp],
  rw [Рєљassociator_inv_naturality_assoc], rw right_adjoint_mate,
end

lemma functor_map_well_defined_3_1:
  functor_map_well_defined_3_lhs V R ╬▓ =
  functor_map_well_defined_3_rhs V R ╬▓ :=
  eq.trans
    (functor_map_well_defined_3_left V R ╬▓ (by rw [functor_map, R.relation_2]))
    (functor_map_well_defined_3_right V R ╬▓).symm

lemma functor_map_well_defined_3_2:
  functor_map_well_defined_3_lhs V R ╬▓РЂ╗┬╣ =
  functor_map_well_defined_3_rhs V R ╬▓РЂ╗┬╣ :=
  eq.trans
    (functor_map_well_defined_3_left V R ╬▓РЂ╗┬╣ (by rw [functor_map, relation_2_c_inv]))
    (functor_map_well_defined_3_right V R ╬▓РЂ╗┬╣).symm

lemma functor_map_well_defined_4_1:
  functor_map V R (╬▓ РЅФрхљ ╬▓РЂ╗┬╣) = functor_map V R (­ЮЪЎрхљ (РєЊ РіЌрхЌ РєЊ)) :=
by simp [functor_map]

lemma functor_map_well_defined_4_2:
  functor_map V R (╬▓РЂ╗┬╣ РЅФрхљ ╬▓) = functor_map V R (­ЮЪЎрхљ (РєЊ РіЌрхЌ РєЊ)) :=
by simp [functor_map]

lemma functor_map_well_defined_5:
  functor_map V R (╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ╬▓ РіЌрхљ ­ЮЪЎрхљ РєЊ РЅФрхљ ╬▒ _ _ _ РЅФрхљ ­ЮЪЎрхљ РєЊ РіЌрхљ ╬▓ РЅФрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ╬▓ РіЌрхљ ­ЮЪЎрхљ _) = functor_map V R (­ЮЪЎрхљ РєЊ РіЌрхљ ╬▓ РЅФрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ╬▓ РіЌрхљ ­ЮЪЎрхљ РєЊ РЅФрхљ ╬▒ _ _ _ РЅФрхљ ­ЮЪЎрхљ РєЊ РіЌрхљ ╬▓ РЅФрхљ ╬▒РЂ╗┬╣ _ _ _) :=
by dsimp [functor_map]; exact R.relation_1.symm

lemma functor_map_well_defined_6_1:
  functor_map V R (¤ЂРЂ╗┬╣ _ РЅФрхљ ­ЮЪЎрхљ РєЊ РіЌрхљ ╬иРЂ║ РЅФрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ╬▓ РіЌрхљ ­ЮЪЎрхљ РєЉ РЅФрхљ ╬▒ _ _ _ РЅФрхљ ­ЮЪЎрхљ РєЊ РіЌрхљ ╬хРЂ╗ РЅФрхљ ¤Ђ _) = functor_map V R (­ЮЪЎрхљ РєЊ) :=
begin
  simp [functor_map],
  change (¤Ђ_ _).inv РЅФ (­ЮЪЎ V РіЌ ╬и_РЂ║ V) РЅФ (╬▒_ _ _ _).inv РЅФ (R.c.hom РіЌ ­ЮЪЎ VрўЂ) РЅФ (╬▒_ _ _ _).hom РЅФ (­ЮЪЎ V РіЌ R.╬╝.hom РіЌ ­ЮЪЎ VрўЂ) РЅФ (­ЮЪЎ V РіЌ ╬х_РЂ╗ V) РЅФ (¤Ђ_ _).hom = ­ЮЪЎ V,
  have h: trace_2 (R.c.hom РЅФ (­ЮЪЎ V РіЌ R.╬╝.hom)) = (¤Ђ_ _).inv РЅФ (­ЮЪЎ V РіЌ ╬и_РЂ║ V) РЅФ (╬▒_ _ _ _).inv РЅФ (R.c.hom РіЌ ­ЮЪЎ VрўЂ) РЅФ (╬▒_ _ _ _).hom РЅФ (­ЮЪЎ V РіЌ R.╬╝.hom РіЌ ­ЮЪЎ VрўЂ) РЅФ (­ЮЪЎ V РіЌ ╬х_РЂ╗ V) РЅФ (¤Ђ_ _).hom :=
    by simp [functor_map, trace_2, coevaluation, evaluation, evaluation_rev],
  rw Рєљh,
  exact R.relation_3_1,
end
lemma functor_map_well_defined_6_2:
  functor_map V R (¤ЂРЂ╗┬╣ _ РЅФрхљ ­ЮЪЎрхљ РєЊ РіЌрхљ ╬иРЂ║ РЅФрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ╬▓РЂ╗┬╣ РіЌрхљ ­ЮЪЎрхљ РєЉ РЅФрхљ ╬▒ _ _ _ РЅФрхљ ­ЮЪЎрхљ РєЊ РіЌрхљ ╬хРЂ╗ РЅФрхљ ¤Ђ _) = functor_map V R (­ЮЪЎрхљ РєЊ) :=
begin
  simp [functor_map],
  change (¤Ђ_ _).inv РЅФ (­ЮЪЎ V РіЌ ╬и_РЂ║ V) РЅФ (╬▒_ _ _ _).inv РЅФ (R.c.inv РіЌ ­ЮЪЎ VрўЂ) РЅФ (╬▒_ _ _ _).hom РЅФ (­ЮЪЎ V РіЌ R.╬╝.hom РіЌ ­ЮЪЎ VрўЂ) РЅФ (­ЮЪЎ V РіЌ ╬х_РЂ╗ V) РЅФ (¤Ђ_ _).hom = ­ЮЪЎ V,
  have h: trace_2 (R.c.inv РЅФ (­ЮЪЎ V РіЌ R.╬╝.hom)) = (¤Ђ_ _).inv РЅФ (­ЮЪЎ V РіЌ ╬и_РЂ║ V) РЅФ (╬▒_ _ _ _).inv РЅФ (R.c.inv РіЌ ­ЮЪЎ VрўЂ) РЅФ (╬▒_ _ _ _).hom РЅФ (­ЮЪЎ V РіЌ R.╬╝.hom РіЌ ­ЮЪЎ VрўЂ) РЅФ (­ЮЪЎ V РіЌ ╬х_РЂ╗ V) РЅФ (¤Ђ_ _).hom :=
    by simp [functor_map, trace_2, coevaluation, evaluation, evaluation_rev],
  rw Рєљh,
  exact R.relation_3_2,
end

lemma functor_map_well_defined_7_1:
  functor_map V R (РёЊРЂ╗┬╣ _ РЅФрхљ ╬иРЂ╗ РіЌрхљ ­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ ╬▒ _ _ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▓РЂ╗┬╣ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▒ _ _ _ РЅФрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ (­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _) РіЌрхљ ╬хРЂ╗ РЅФрхљ (­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _) РіЌрхљ ╬иРЂ║ РЅФрхљ ╬▒ _ _ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▓ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▒ _ _ _ РЅФрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ╬хРЂ║ РіЌрхљ ­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ РёЊ _) = functor_map V R (­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _) :=
by dsimp [functor_map]; exact R.relation_4_1

lemma functor_map_well_defined_7_2:
  functor_map V R (РёЊРЂ╗┬╣ _ РЅФрхљ ╬иРЂ╗ РіЌрхљ ­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ ╬▒ _ _ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▓ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▒ _ _ _ РЅФрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ (­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _) РіЌрхљ ╬хРЂ╗ РЅФрхљ (­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _) РіЌрхљ ╬иРЂ║ РЅФрхљ ╬▒ _ _ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▓РЂ╗┬╣ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▒ _ _ _ РЅФрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ╬хРЂ║ РіЌрхљ ­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ РёЊ _) = functor_map V R (­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _) :=
by dsimp [functor_map]; exact R.relation_4_2

lemma functor_map_well_defined_8_1:
  functor_map V R (¤ЂРЂ╗┬╣ _ РЅФрхљ (­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _) РіЌрхљ ╬иРЂ║ РЅФрхљ ╬▒ _ _ _ РЅФрхљ ­ЮЪЎрхљ РєЉ РіЌрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▓ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▒ _ _ _ РЅФрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ╬хРЂ║ РіЌрхљ ­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ ╬иРЂ╗ РіЌрхљ ­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ ╬▒ _ _ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▓РЂ╗┬╣ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ ­ЮЪЎрхљ РєЉ РіЌрхљ ╬▒ _ _ _ РЅФрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ (­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _) РіЌрхљ ╬хРЂ╗ РЅФрхљ ¤Ђ _) = functor_map V R (­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _) :=
by dsimp [functor_map]; exact R.relation_4_3

lemma functor_map_well_defined_8_2:
  functor_map V R (¤ЂРЂ╗┬╣ _ РЅФрхљ (­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _) РіЌрхљ ╬иРЂ║ РЅФрхљ ╬▒ _ _ _ РЅФрхљ ­ЮЪЎрхљ РєЉ РіЌрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▓РЂ╗┬╣ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▒ _ _ _ РЅФрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ╬хРЂ║ РіЌрхљ ­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ ╬иРЂ╗ РіЌрхљ ­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ ╬▒ _ _ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ ­ЮЪЎрхљ _ РіЌрхљ ╬▓ РіЌрхљ ­ЮЪЎрхљ _ РЅФрхљ ­ЮЪЎрхљ РєЉ РіЌрхљ ╬▒ _ _ _ РЅФрхљ ╬▒РЂ╗┬╣ _ _ _ РЅФрхљ (­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _) РіЌрхљ ╬хРЂ╗ РЅФрхљ ¤Ђ _) = functor_map V R (­ЮЪЎрхљ _ РіЌрхљ ­ЮЪЎрхљ _) :=
by dsimp [functor_map]; exact R.relation_4_4

lemma functor_map_well_defined {X Y}: Рѕђ (f g: X РЪХрхљ Y), f РЅѕ g Рєњ functor_map V R f = functor_map V R g := begin
  intros f g r, induction r,
  { refl, },
  { rw r_ih, },
  { rw [r_ih_рЙ░, r_ih_рЙ░_1], },
  { simp only [functor_map, r_ih_рЙ░, r_ih_рЙ░_1], },
  { simp only [functor_map, category.id_comp'], },
  { simp only [functor_map, category.comp_id'], },
  { simp only [functor_map, category.assoc'], },
  { simp only [functor_map, r_ih_рЙ░, r_ih_рЙ░_1], },
  { simp only [functor_map, monoidal_category.tensor_id'], refl, },
  { simp only [functor_map, monoidal_category.tensor_comp'], },
  { simp only [functor_map, (╬▒_ _ _ _).hom_inv_id'], refl, },
  { simp only [functor_map, (╬▒_ _ _ _).inv_hom_id'], refl, },
  { simp only [functor_map, monoidal_category.associator_naturality'], },
  { simp only [functor_map, (╬╗_ _).hom_inv_id'], refl, },
  { simp only [functor_map, (╬╗_ _).inv_hom_id'], },
  { simp only [functor_map, monoidal_category.left_unitor_naturality'], dsimp at *, simp at *, },
  { simp only [functor_map, (¤Ђ_ _).hom_inv_id'], refl, },
  { simp only [functor_map, (¤Ђ_ _).inv_hom_id'], },
  { simp only [functor_map, monoidal_category.right_unitor_naturality'], dsimp at *, simp at *, },
  { dsimp [functor_map], rw monoidal_category.pentagon', },
  { simp only [functor_map, monoidal_category.triangle'], dsimp at *, simp at *, },
  exact aux.functor_map_well_defined_1_1 V R,
  exact aux.functor_map_well_defined_1_2 V R,
  exact aux.functor_map_well_defined_2_1 V R,
  exact aux.functor_map_well_defined_2_2 V R,
  exact aux.functor_map_well_defined_3_1 V R,
  exact aux.functor_map_well_defined_3_2 V R,
  exact aux.functor_map_well_defined_4_1 V R,
  exact aux.functor_map_well_defined_4_2 V R,
  exact aux.functor_map_well_defined_5 V R,
  exact aux.functor_map_well_defined_6_1 V R,
  exact aux.functor_map_well_defined_6_2 V R,
  exact aux.functor_map_well_defined_7_1 V R,
  exact aux.functor_map_well_defined_7_2 V R,
  exact aux.functor_map_well_defined_8_1 V R,
  exact aux.functor_map_well_defined_8_2 V R,
end

end aux

@[simp] def functor (R: enhanced_R_matrix C V): Tangle РЦц C := {
  obj := functor_obj V,
  map := ╬╗ X Y f, quotient.lift_on' f (functor_map V R) (aux.functor_map_well_defined V R)
}

end enhanced_R_matrix
end kassel
